{% extends 'layouts/base.html' %}

{% load svg static %}

{% block body_classes %}app-template__body{% endblock %}

{% block title %}
	{{ case.reference_code }} - {{ case.application.organisation.name }}
{% endblock %}

{% block header %}
	<div class="app-case-header__container">
		<div class="app-case-header__aurora" style="background: {{ case.all_flags|aurora }}"></div>
		<div class="app-case-header">
			<div class="app-case-header__stuff">
				<div class="app-case-header__content">
					<ol class="app-case-header__breadcrumbs-list">
						<li class="app-case-header__breadcrumbs-list-item">
							<a class="app-case-header__breadcrumbs-link" href="{% url 'queues:cases' queue.id %}">{{ queue.name }}</a>
						</li>
					</ol>
					<h1 class="app-case-header__heading" style="z-index: 10;">
						{{ case.reference_code }} <a class="app-case-header__link govuk-!-margin-left-2" style="opacity: 0.7;" href="{% url 'organisations:organisation' case.application.organisation.id %}?return_to={{ CURRENT_PATH }}&return_to_text={{ case.reference_code }}">{{ case.application.organisation.name }}</a>
					</h1>
				</div>
				<div class="app-case-header__controls">
					<div class="app-case-header__candy-bar">
						<span id="candy-goods" class="app-case-header__candy" data-tooltip="{{ case.application.goods|length|default:case.application.goods_types|length }} goods">
							{% svg 'goods' %}
							{{ case.application.goods|length|default:case.application.goods_types|length }}
						</span>
						<div id="popup-goods">
							{% include 'case/pills/goods.html' %}
						</div>
						<span id="candy-countries" class="app-case-header__candy" data-tooltip="{{ case.application.destinations.data|length }} destination{{ case.application.destinations.data|pluralize }}">
							{% svg 'globe' %}
							{{ case.application.destinations.data|length }}
						</span>
						<div id="popup-countries">
							{% include 'case/pills/countries.html' %}
						</div>
						<span id="candy-flags" class="app-case-header__candy" data-tooltip="{{ case.flags|length }} flag{{ case.flags|pluralize }}">
							{% svg 'menu/flags' %}
							{{ case.all_flags|length }}
						</span>
						<div id="popup-flags">
							{% include 'case/pills/flags.html' %}
						</div>
						<span id="candy-case-officer" class="app-case-header__candy" data-tooltip="Case officer and assigned users">
							{% svg 'menu/users' %}
							{% if case.case_officer %}
								{{ case.case_officer.first_name }} {{ case.case_officer.last_name }}
							{% else %}
								Not assigned
							{% endif %}
						</span>
						<div id="popup-case-officer" class="">
							{% include 'case/pills/case-officer.html' %}
						</div>
					</div>

					<div class="app-case-header__candy-bar">
						<span class="app-case-header__candy app-case-header__candy--big" data-tooltip="Status">
							{{ case.application.status.value }}
						</span>
					</div>
				</div>
			</div>
			{% if not hide_flags_row %}
				<div class="app-case__flags-bar" id="case-flags">
					{% include 'includes/flags.html' with flags=case.all_flags|slice:6 show_change_link=True %}
				</div>
			{% endif %}
		</div>
		{% if tabs %}
			<div id="tab-bar" class="app-case-tab-bar">
				<div class="govuk-width-container lite-tabs__container">
					<div class="lite-tabs">
						{% for tab in tabs %}
							<a id="{{ tab.id }}" href="{% url 'cases:case' queue.id case.id tab.url %}" class="lite-tabs__tab {% if tab.url == current_tab %}lite-tabs__tab--selected{% endif %}">
								{{ tab.name }}
							</a>
						{% endfor %}
					</div>
					<div class="lite-tabs__controls">
						{% govuk_link_button text='cases.CasePage.IM_DONE_BUTTON' url='queues:cases' classes='govuk-button--secondary' %}
					</div>
				</div>
			</div>
		{% endif %}
	</div>
{% endblock %}

{% block body %}

	<div class="">
		{% if permissions|key_in_array:'MAKE_FINAL_DECISIONS' %}
			<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:decide' queue.id case.id %}">
				{% lcs 'cases.ApplicationPage.Actions.DECISION' %}
			</a>
		{% endif %}
	</div>

	<!-- <br> -->

	<!-- <p>{{ case.all_flags|aurora }}</p> -->

	<!-- {% include 'includes/flags.html' with flags=case.all_flags %} -->

	<!-- <a class="govuk-link govuk-link--no-visited-state" href="{% url 'cases:assign_flags' queue.id case.id %}?level=cases&items={{ case.id }}" id="application-edit-case-flags">Change case flags</a> -->

	{% block details %}
		<div class="modal-bg">

		</div>
		<div class="modal">
			{% block two_thirds %}{% endblock %}
		</div>
	{% endblock %}
{% endblock %}

{% block javascript %}
	<script type="text/javascript">
		const goods = document.getElementById('popup-goods');
		goods.style.display = 'block';
		tippy("#candy-goods", {
			content: goods,
		 	allowHTML: true,
			interactive: true,
			animation: 'scale-subtle',
      		trigger: 'click',
			theme: 'light',
			placement: 'bottom'
		});

		const countries = document.getElementById('popup-countries');
		countries.style.display = 'block';
		tippy("#candy-countries", {
			content: countries,
			allowHTML: true,
			interactive: true,
			animation: 'scale-subtle',
			trigger: 'click',
			theme: 'light',
			placement: 'bottom'
		});

		const flags = document.getElementById('popup-flags');
		flags.style.display = 'block';
		tippy("#candy-flags", {
			content: flags,
			allowHTML: true,
			interactive: true,
			animation: 'scale-subtle',
			trigger: 'click',
			theme: 'light',
			placement: 'bottom'
		});

		const users = document.getElementById('popup-case-officer');
		users.style.display = 'block';
		tippy("#candy-case-officer", {
			content: users,
			allowHTML: true,
			interactive: true,
			animation: 'scale-subtle',
			trigger: 'click',
			theme: 'light',
			placement: 'bottom'
		});

		window.addEventListener('scroll', function (e) {
			var scrollPosition = window.scrollY;

			if (scrollPosition > 80) {
				$("#tab-bar").addClass("app-case-tab-bar--float");
			} else {
				$("#tab-bar").removeClass("app-case-tab-bar--float");
			}

			var padding = Math.max(15, 30 - (scrollPosition / 3));
			var paddingFlags = Math.max(20 - scrollPosition, -38);  // 38 is the height of the shrunk case header
			$(".app-case-header").css({"padding-top": padding, "padding-bottom": padding});
			$(".app-case-header__breadcrumbs-list").css({"opacity": 1 - (scrollPosition / 10), "transform": "translateY(" + -(30 - padding) + "px)", "margin-top": -(30 - padding) + "px", "margin-bottom": -(20 - padding) + "px"});
			$("#case-flags").css({"opacity": 1 - (scrollPosition / 10), "transform": "translateY(" + -(30 - padding) + "px)", "margin-top": paddingFlags + "px"});
		});
	</script>
	<script src="{% static "javascripts/select-buttons.js" %}"></script>
	<script src="{% static "javascripts/modal.js" %}"></script>
	<script src="{% static "javascripts/case.js" %}"></script>
{% endblock %}
