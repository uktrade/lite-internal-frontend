{% extends 'layouts/base.html' %}

{% load svg static %}

{% block back_link %}
	{% include "case/views/includes/breadcrumbs.html" %}
{% endblock %}

{% block body_classes %}lite-main-wrapper--case{% endblock %}

{% block body %}
	{% include 'includes/messages.html' %}

	{% if case.audit_notification %}
		<a id="audit-notification" class="lite-info-bar lite-info-bar--link lite-info-bar--no-animation" href="#case-activity-{{ case.audit_notification.audit_id }}">
			{% lcs 'CASE_CHANGES' %}
		</a>
	{% endif %}

	<div class="lite-app-bar">
		<div class="lite-app-bar__content">
			<h1 id="heading-reference-code" class="govuk-heading-l govuk-!-margin-0">
				{% block title %}
					{{ case.reference_code }}
				{% endblock %}
			</h1>
		</div>
		<div class="lite-app-bar__controls">
			<div class="govuk-!-margin-right-3">
				{% if can_set_done %}
					{% make_list queue.id case.id as done_params %}
					{% govuk_link_button id='done' text='cases.ApplicationPage.DONE_WITH_CASE' url='cases:done' url_param=done_params %}
				{% endif %}

				{% block additional_controls %}
				{% endblock %}
			</div>
			<div id="actions-list" class="lite-more-actions__container">
				<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:documents' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.DOCUMENT' %}
				</a>
				<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:ecju_queries' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.ECJU' %}
				</a>
				<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:move' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.MOVE' %}
				</a>
				{% if permissible_statuses %}
					{% if not status_is_terminal or 'REOPEN_CLOSED_CASES' in permissions %}
						<a role="button" draggable="false" class="govuk-button" id="change-status" href="{% url 'cases:manage' queue.id case.id %}">
							{% lcs 'cases.ApplicationPage.Actions.CHANGE_STATUS' %}
						</a>
					{% endif %}
				{% endif %}
				{% if permissions|key_in_array:'MAKE_FINAL_DECISIONS' %}
					<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:decide' queue.id case.id %}">
						{% lcs 'cases.ApplicationPage.Actions.DECISION' %}
					</a>
				{% endif %}
				{% if not case.case_type.sub_type.key == "goods" and not case.case_type.sub_type.key == "end_user_advisory" and not case.case_type.sub_type.key == "hmrc"%}
					<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:user_advice_view' queue.id case.id %}">
						{% lcs 'cases.ApplicationPage.Actions.ADVICE' %}
					</a>
				{% endif %}
				<a role="button" draggable="false" class="govuk-button" id="link-additional-contacts" href="{% url 'cases:additional_contacts' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.ADDITIONAL_CONTACTS' %}
				</a>
				<a role="button" draggable="false" class="govuk-button" id="generate-document" href="{% url 'cases:generate_document' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.GENERATE_DOCUMENT' %}
				</a>
				<a role="button" draggable="false" class="govuk-button" id="case-officer" href="{% url 'cases:case_officer' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.CASE_OFFICER' %}
				</a>
				<a role="button" draggable="false" class="govuk-button" id="assign-user" href="{% url 'cases:assign_user' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.USER_WORK_QUEUE' %}
				</a>
				<a role="button" draggable="false" class="govuk-button" id="assign-user" href="{% url 'cases:rerun_routing_rules' queue.id case.id %}">
					{% lcs 'cases.ApplicationPage.Actions.RERUN_ROUTING_RULES' %}
				</a>
			</div>
		</div>
	</div>

	{% if case.case_officer %}
		<p class="govuk-caption-m" id="selected-case-officer">{% lcs 'cases.ApplicationPage.CASE_OFFICER' %} <a class="govuk-link govuk-link--no-visited-state" href="{% url 'users:user' case.case_officer.id %}">{{ case.case_officer|username }}</a></p>
	{% else %}
		<p class="govuk-caption-m" id="selected-case-officer">{% lcs 'cases.ApplicationPage.NO_CASE_OFFICER' %}</p>
	{% endif %}

	{% if case.copy_of %}
		<p class="govuk-caption-m">{% lcs 'cases.ApplicationPage.COPY_OF_LABEL' %}<a class="govuk-link govuk-link--no-visited-state" id="case-copy-of" href="{% url 'cases:case' queue.id case.copy_of.id %}">{{ case.copy_of.reference_code }}</a></p>
	{% endif %}

	<div class="govuk-!-margin-bottom-6" id="case_queues">
		{% for queue_name in case.queue_names %}
			<div class="govuk-caption-m">{{ queue_name }}</div>
		{% empty %}
			<span class="govuk-caption-m">{% lcs 'cases.ApplicationPage.NO_QUEUES_ASSIGNED' %}</span>
		{% endfor %}
	</div>

	<div class="govuk-!-margin-bottom-6" id="assigned_users">
		{% for user in case.users %}
			<div class="govuk-caption-m">
				<span>{{ user.queue }}:</span>
					{% if user.first_name %}
						{{ user.first_name }} {{ user.last_name }}
					{% else %}
						{{ user.email }}
					{% endif %}
			</div>
		{% empty %}
			<span class="govuk-caption-m">{% lcs 'cases.ApplicationPage.NO_USERS_ASSIGNED' %}</span>
		{% endfor %}
	</div>

	<h2 class="govuk-heading-s">Case flags <a class="govuk-link govuk-link--no-visited-state govuk-!-margin-left-9" href="{% url 'cases:assign_flags' queue.id case.id %}?level=cases&items={{ case.id }}" id="application-edit-case-flags">Change case flags</a></h2>

	{% include "includes/flags.html" with flags=case.flags %}

	<h2 class="govuk-heading-s">All flags</h2>

	{% include "includes/flags.html" with flags=case.all_flags %}

	{% block details %}{% endblock %}
{% endblock %}

{% block javascript %}
	<script src="{% static "javascripts/select-buttons.js" %}"></script>
	<script src="{% static "javascripts/more-actions.js" %}"></script>
	<script src="{% static "javascripts/modal.js" %}"></script>
	<script src="{% static "javascripts/case.js" %}"></script>
{% endblock %}
