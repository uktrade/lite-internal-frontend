{% extends 'layouts/base.html' %}

{% load svg static %}

{% block back_link %}{% endblock %}

{% block title %}
	{{ queue.name }}
{% endblock %}

{% block messages %}
	{{ block.super }}

	{% if updated_cases_banner_queue_id %}
		<a id="banner-exporter-amendments" class="govuk-width-container app-snackbar app-snackbar--no-animation" href="{% url 'queues:cases' updated_cases_banner_queue_id %}">
			<div class="app-snackbar__content">
				<div class="app-snackbar__icon"></div>
				{% lcs 'cases.CasesListPage.EXPORTER_AMENDMENTS_BANNER' %}
			</div>
		</a>
	{% endif %}
{% endblock %}

{% block body %}
	<div class="lite-app-bar">
		<div class="lite-app-bar__content">
			<h1 class="govuk-heading-l">
				<a tabindex="0" id="link-queue" href="{% url 'queues:manage' %}" class="app-dropdown__heading">
					{{ queue.name }}<span class="govuk-visually-hidden"> (Click to change queue)</span>
				</a>
			</h1>
		</div>
		{% if not queue.is_system_queue %}
			<div class="lite-app-bar__controls lite-buttons-row" >
				<div data-enable-on-checkboxes="#table-cases">
					<button id="assign-users-button" form="cases-form" type="submit" class="govuk-button govuk-button--secondary">{% lcs 'cases.CasesListPage.ASSIGN_USERS' %}</button>
				</div>
				{% if enforcement_check and data.results.cases %}
					{% govuk_link_button id='export-xml' classes='govuk-button--secondary' text='cases.CasesListPage.EnforcementXML.EXPORT_BUTTON' url='queues:enforcement_xml_export' url_param=queue.id %}
					{% govuk_link_button id='import-xml' classes='govuk-button--secondary' text='cases.CasesListPage.EnforcementXML.IMPORT_BUTTON' url='queues:enforcement_xml_import' url_param=queue.id %}
				{% endif %}
			</div>
		{% endif %}
	</div>

	<div id="queues" class="app-hidden">
		<div class="app-menu__search">
			<div>
				{% svg 'search' %}
			</div>
			<input type="text" id="filter-queues">
		</div>
	</div>

	<p id="text-case-count" class="lite-filters__hint-text app-hidden">cases in this queue</p>

	{% include 'filters.html' %}

	<table id="table-placeholder" class="govuk-table app-table--skeleton">
		<thead class="govuk-table__head">
			<tr class="govuk-table__row">
				{% if not data.results.is_system_queue %}
					<th class="govuk-table__header govuk-table__cell--tight">
						<div class="app-table__row__checkbox--skeleton"></div>
					</th>
				{% endif %}
				<th class="govuk-table__header govuk-table__cell--tight" scope="col"><span class="govuk-visually-hidden">{% lcs 'cases.CasesListPage.Table.SLA' %}</span></th>
				<th class="govuk-table__header govuk-table__cell--tight" scope="col"><span class="govuk-visually-hidden">{% lcs 'cases.CasesListPage.Table.INFORMATION' %}</span></th>
				<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.CASE' %}</th>
				<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.ASSIGNEES' %}</th>
				<th class="govuk-table__header app-table__header--skeleton lite-tablet-hide" scope="col">{% lcs 'cases.CasesListPage.Table.GOODS' %}</th>
				<th class="govuk-table__header app-table__header--skeleton lite-tablet-hide" scope="col">{% lcs 'cases.CasesListPage.Table.DESTINATIONS' %}</th>
				<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.FLAGS' %}</th>
				<th class="govuk-table__header" scope="col"></th>
			</tr>
		</thead>
		<tbody id="tbody-placeholder">
			{% for i in '01234567890123456789'|make_list %}
				<tr class="govuk-table__row app-table__row--skeleton">
					<td class="govuk-table__cell">
						<div class="app-table__row__checkbox--skeleton"></div>
					</td>
					<td class="govuk-table__cell"></td>
					<td class="govuk-table__cell"></td>
					<td class="govuk-table__cell">
						<div class="">
							<p>hello world my name</p>
						</div>
						<div class="">
							<p>world is jan</p>
						</div>
						<div class="">
							<p>easy</p>
						</div>
						<div class="">
							<p>to find</p>
						</div>
					</td>
					<td class="govuk-table__cell">
						<p>hello hello</p>
					</td>
					<td class="govuk-table__cell">
						<p>hello hello</p>
					</td>
					<td class="govuk-table__cell">
						<p>hello hello</p>
					</td>
					<td class="govuk-table__cell">
						<p>hello hello</p>
					</td>
				</tr>
			{% endfor %}
		</tbody>
	</table>

	<table id="table-cases" class="govuk-table">
		<thead class="govuk-table__head">
			<tr class="govuk-table__row">
				{% if not data.results.is_system_queue %}
					<th class="govuk-table__header govuk-table__cell--checkbox">
						<button id="button-select-all" type="button" name="button" class="lite-button-checkbox" title="Select all/Deselect all"></button>
					</th>
				{% endif %}
				<th class="govuk-table__header govuk-table__cell--tight" scope="col"><span class="govuk-visually-hidden">{% lcs 'cases.CasesListPage.Table.SLA' %}</span></th>
				<th class="govuk-table__header govuk-table__cell--tight" scope="col"><span class="govuk-visually-hidden">{% lcs 'cases.CasesListPage.Table.INFORMATION' %}</span></th>
				<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.CASE' %}</th>
				<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.ASSIGNEES' %}</th>
				<th class="govuk-table__header app-table__header--skeleton lite-tablet-hide" scope="col">{% lcs 'cases.CasesListPage.Table.GOODS' %}</th>
				<th class="govuk-table__header app-table__header--skeleton lite-tablet-hide" scope="col">{% lcs 'cases.CasesListPage.Table.DESTINATIONS' %}</th>
				<th class="govuk-table__header app-table__header--skeleton" scope="col">{% lcs 'cases.CasesListPage.Table.FLAGS' %}</th>
				<th class="govuk-table__header" scope="col"></th>
			</tr>
		</thead>
		<tbody id="tbody-main">
		</tbody>
	</table>

	<form id="cases-form" method="post">
		{% csrf_token %}
	</form>
{% endblock %}

{% block javascript %}
	<script src="{% static 'javascripts/cases.js' %}"></script>
	<script src="{% static 'javascripts/select-buttons.js' %}"></script>

	<script nonce="{{ request.csp_nonce }}">
		function shortenName(first_name, last_name) {
			if (!first_name || !last_name ) {
				return "";
			}

			return first_name[0] + last_name[0];
		}

		function generateAssignments(assignments) {
			if (assignments.length) {
				var container = `<div class="app-assignments__container"><ul class="app-assignments__list">`;
				$.each(assignments.slice(0, 3), function(i, item) {
					container = container + `
						<li class="app-assignments__item" data-tooltip="${(item.user.first_name ? item.user.first_name + " " + item.user.last_name : item.user.email)}">${shortenName(item.user.first_name, item.user.last_name)}</li>
					`;
				});
				if (assignments.length > 3) {
					container = container + `
						</ul><p class="app-assignments__link">${assignments.length - 3} more</p>
					`
				} else {
					container = container + `</ul>`;
				}
				return container + `</div>`;
			} else {
				return `<p class="app-information-bar">{% lcs 'cases.CasesListPage.NoContent.NO_GOODS_FLAGS' %}</p>`
			}
		}

		function generateFlags(flags) {
			if (flags.length) {

			} else {
				return `<p class="app-information-bar">{% lcs 'cases.CasesListPage.NoContent.NO_GOODS_FLAGS' %}</p>`
			}
		}

		$("#table-cases").hide();
		$.get("{% url 'core:cases' queue.id %}", function(data) {
			$("#table-placeholder").hide();
			$("#table-cases").fadeIn(100);
			$("#text-case-count").fadeIn(100).text(data.count + " cases");
			$.each(data.results.queues, function(i, item) {
				var html = `
					<a href="/queues/${item.id}/" id="${item.id}" class="app-menu__item app-menu__item--subtitle ${(item.id == '{{ queue.id }}' ? 'app-menu__item--selected' : '')}">
						${item.name}
						<span class="app-menu__item-subtitle">${item.case_count}</span>
					</a>
				`;
				$("#queues").append(html);
			});
			generateQueuesMenu();
			if (data.results.cases.length) {
				$.each(data.results.cases, function(i, item) {
					var html = `
						<tr class="govuk-table__row" id="${item.id}">
							{% if not data.results.is_system_queue %}
								<td class="govuk-table__cell govuk-table__cell--checkbox">
									<div>
										<input class="govuk-checkboxes__input" type="checkbox" name="cases" value="{{ case.id }}">
										<label class="govuk-label govuk-checkboxes__label">
											<span class="govuk-visually-hidden"></span>
										</label>
									</div>
								</td>
							{% endif %}
							<td class="govuk-table__cell govuk-table__cell--tight">
								{% if case.sla_hours_since_raised != None or case.sla_remaining_days != None %}
									{% if case.sla_hours_since_raised != None and case.case_type.sub_type.key == 'hmrc'%}
										<div class="pie-wrapper progress-{{ case|get_sla_hours_percentage }} {{ case|get_sla_hours_ring_colour }}" id="sla">
											<span class="label">{{ case.sla_hours_since_raised }}</span>
											<div class="pie">
												<div class="left-side half-circle"></div>
												<div class="right-side half-circle"></div>
											</div>
										</div>
									{% elif case.sla_remaining_days != None and case.case_type.sub_type.key != 'hmrc'%}
										<div class="pie-wrapper progress-{{ case|get_sla_percentage }} {{ case|get_sla_ring_colour }}" id="sla">
											<span class="label">{{ case.sla_days }}</span>
											<div class="pie">
												<div class="left-side half-circle"></div>
												<div class="right-side half-circle"></div>
											</div>
										</div>
									{% endif %}
								{% endif %}
							</td>
							<td class="govuk-table__cell govuk-table__cell--tight lite-mobile-hide">
								<div class="app-cases__row__vertical-column">
									{% if not is_all_cases_queue %}
										${(!item.is_recently_updated ? `
											<span data-tooltip="{% lcs 'cases.CasesListPage.NOT_UPDATED_RECENTLY' %}" class="app-cases__row__icon app-cases__row__attention-needed">
												!
											</span>
											`: ``)}
									{% endif %}
									{% if data.results.is_work_queue %}
										${(item.has_open_ecju_queries ? `
											<div data-tooltip="{% lcs 'cases.CasesListPage.OPEN_TEAM_ECJU' %}" class="app-cases__row__icon">
												{% svg 'ecju-query' %}
											</div>
											` : ``)}
									{% endif %}
								</div>
							</td>
							<td class="govuk-table__cell">
								<a class="govuk-link govuk-link--no-visited-state" id="case-{{ case.id }}" href="/queues/{{ queue.id }}/cases/${item.id}/">
									<span class="govuk-visually-hidden">View</span> ${item.reference_code}
								</a>
								<p class="govuk-body govuk-!-margin-top-2 govuk-!-margin-bottom-0">
									${item.organisation.name} <span class="govuk-hint lite-!-display-inline">/ ${item.organisation.primary_site.address.city }</span>
								</p>
								<p class="govuk-hint govuk-!-margin-0 govuk-!-margin-top-2">${item.organisation.primary_site.address.postcode }</p>
								<p class="govuk-tag govuk-tag--grey govuk-!-margin-0 govuk-!-margin-top-2">${item.status.value }</p>
							</td>
							<td class="govuk-table__cell lite-mobile-hide">
								${generateAssignments(item.assignments)}
							</td>
							<td class="govuk-table__cell lite-tablet-hide">
								${generateFlags(item.flags)}
							</td>
							<td class="govuk-table__cell lite-tablet-hide">
								${generateFlags(item.flags)}
							</td>
							<td class="govuk-table__cell lite-mobile-hide" id="flags-{{ case.id }}">
								${generateFlags(item.flags)}
							</td>
						</tr>
					`
					$("#tbody-main").append(html);
				});
			}
			setTooltips();
		});

		$("#filter-queues").on('input', function() {
			txt = $("#filter-queues").val();
			anyVisible = false;
			$('#queues a').hide();
			$("#queues > span").hide();
			$('#queues a').each(function(){
				if ($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1){
					$(this).show();
					anyVisible = true;
				}
			});

			if (!anyVisible) {
				$("#queues > span").show()
			}
		});

		$("#link-queue").removeAttr("href");

		function generateQueuesMenu() {
			const queuesMenu = document.getElementById('queues');
			queuesMenu.style.display = 'block';
			tippy("#link-queue", {
				content: queuesMenu,
				allowHTML: true,
				interactive: true,
				animation: 'scale-subtle',
				trigger: 'click',
				theme: 'light',
				placement: 'bottom-start',
				arrow: null,
				onShown(instance) {
					$("#filter-queues").val("")
					$("#filter-queues").focus()
				},
			});
		}
	</script>
{% endblock %}
