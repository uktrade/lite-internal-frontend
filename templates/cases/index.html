{% extends 'layouts/base.html' %}

{% load svg static %}

{% block back_link %}{% endblock %}

{% block body %}
	{% if updated_cases_banner_queue_id %}
		<a id="exporter-amendments-banner" class="lite-info-bar lite-info-bar--link lite-info-bar--no-animation" href="?queue_id={{ updated_cases_banner_queue_id }}">
			{% lcs 'cases.CasesListPage.EXPORTER_AMENDMENTS_BANNER' %}
		</a>
	{% endif %}

	<div class="lite-app-bar">
		<form method="get" class="app-dropdown__select">
			<select class="govuk-select" name="queue_id">
				{% for queue in data.results.queues %}
					<option value="{{ queue.id }}" {% if queue.id == data.results.queue.id %}selected{% endif %}>{{ queue.name }}</option>
				{% endfor %}
			</select>
			<button type="submit" class="govuk-button">{% lcs 'cases.CasesListPage.GO_TO_QUEUE' %}</button>
		</form>
		<a id="queue-title" href="#" class="govuk-heading-l app-dropdown__heading" onclick="toggleDropdown()">
			{{ data.results.queue.name }}
		</a>
		{% if not data.results.is_system_queue %}
			<div class="lite-app-bar__controls">
				<button id="assign-users-button" form="cases-form" type="submit" class="govuk-button govuk-button--secondary">{% lcs 'cases.CasesListPage.ASSIGN_USERS' %}</button>
			</div>
		{% endif %}
	</div>

	<div class="app-dropdown__background" onclick="toggleDropdown()"></div>
	<div class="app-dropdown__container" id="queues">
		<div class="app-dropdown__list">
			{% for queue in data.results.queues %}
			<a href="?queue_id={{queue.id}}" id="{{ queue.name }}" class="app-dropdown__item {% if queue.id == data.results.queue.id %}app-dropdown__item--selected{% endif %}">
				{{ queue.name }}
				<span class="app-dropdown__item__count">{{ queue.case_count }}</span>
			</a>
			{% endfor %}
		</div>
	</div>

	{% include "filters.html" %}

	<form id="cases-form" method="post">
		{% csrf_token %}
		{% if data.results.cases|length %}
			<table class="govuk-table">
				<thead class="govuk-table__head">
					<tr class="govuk-table__row">
						<th class="cases-table__header cases-table__cell--checkbox">
							<button id="button-select-all" type="button" name="button" class="lite-button-checkbox" title="Select all/Deselect all"></button>
						</th>
						<th class="cases-table__header" style="width: 225px;" scope="col">Case</th>
						<th class="cases-table__header" style="width: 1fr;" scope="col">Assignees</th>
						<th class="cases-table__header" style="width: 125px;" scope="col">Type</th>
						<th class="cases-table__header" style="width: 125px;" scope="col">Queue</th>
						<th class="cases-table__header" style="width: 200px;" scope="col">Flags</th>
						<th class="cases-table__header" style="width: 200px;" scope="col">SLA Target</th>
						<th class="cases-table__header" style="width: 125px;" scope="col">
							<a href="{% url 'cases:cases' %}?{{ params_str }}&sort={{ 'status'|table_sort_text:params }}" id="sort-status" class="app-table__sortable-header {{ 'status'|table_sort:params }}">
								{% lcs 'cases.CasesListPage.STATUS' %}
								{% svg 'chevron' %}
							</a>
						</th>
						<th class="cases-table__header" scope="col"></th>
					</tr>
				</thead>
				<tbody class="govuk-table__body">
					{% for case in data.results.cases %}
						<tr class="govuk-table__row lite-accordian-table__row" id="{{ case.id }}">
							<td class="cases-table__cell cases-table__cell--checkbox">
								<div class="govuk-checkboxes__item">
									<input class="govuk-checkboxes__input" type="checkbox" name="cases" value="{{ case.id }}">
									<label class="govuk-label govuk-checkboxes__label">
										<span class="govuk-visually-hidden">
											{% if case.case_type.sub_type.key == 'application' or case.case_type.sub_type.key == 'hmrc' %}
												{{ case.id }}
											{% else %}
												{{ case.query.id }}
											{% endif %}
										</span>
									</label>
								</div>
							</td>
							<td class="cases-table__cell">
								<a class="govuk-link govuk-!-font-weight-bold" href="{% url 'cases:case' case.id %}?queue_id={{data.results.queue.id}}&queue_name={{data.results.queue.name}}">
									{{ case.reference_code }}
								</a>
								<p class="govuk-body" style="opacity: .7; magin: 0;">
									{{ case.organisation }}
								</p>
							</td>
							<td class="cases-table__cell">
								{% for user in case.users|slice:":3" %}
									<div>
										{% if data.results.is_system_queue %}
											<span style="opacity: 0.6;">{{ user.queue }}:</span>
										{% endif %}
										{% if user.first_name %}
											{{ user.first_name }} {{ user.last_name }}
										{% else %}
											{{ user.email }}
										{% endif %}
										<span class="lite-hint app-expanded-row__item--invert">
											{% if case.users|length > 3 and forloop.counter == 3 %} (3 of {{case.users|length}}){% endif %}
										</span>
									</div>
								{% empty %}
									<span class="lite-hint">No users assigned</span>
								{% endfor %}
								{% for user in case.users|slice:"3:" %}
									<div class="app-expanded-row__item">
										{% if data.results.is_system_queue %}
											<span style="opacity: 0.6;">{{ user.queue }}:</span>
										{% endif %}
										{% if user.first_name %}
											{{ user.first_name }} {{ user.last_name }}
										{% else %}
											{{ user.email }}
										{% endif %}
									</div>
								{% endfor %}
							</td>
							<td class="cases-table__cell">
								{{ case.case_type.sub_type.value }}
							</td>
							<td class="cases-table__cell">
								{% for queue_name in case.queue_names|slice:":3" %}
									<div>
										{{ queue_name }}
										<span class="lite-hint app-expanded-row__item--invert">
											{% if case.queue_names|length > 3 and forloop.counter == 3 %} (3 of {{case.queue_names|length}}){% endif %}
										</span>
									</div>
								{% endfor %}
								{% for queue_name in case.queue_names|slice:"3:" %}
									<div class="app-expanded-row__item">{{ queue_name }}</div>
								{% endfor %}
							</td>
							<td class="cases-table__cell">
								{% for flag in case.flags|slice:":3" %}
									<div>
										{{ flag.name }}
										<span class="lite-hint app-expanded-row__item--invert">
											{% if case.flags|length > 3 and forloop.counter == 3 %} (3 of {{case.flags|length}}){% endif %}
										</span>
									</div>
								{% endfor %}
								{% for flag in case.flags|slice:"3:" %}
									<div class="app-expanded-row__item">
										{{ flag.name }}
									</div>
								{% endfor %}
							</td>
							<td class="cases-table__cell">
								{{ case.sla_days }} / {{ case.sla_remaining_days }}
							</td>
							<td class="cases-table__cell">
								{{ case.status.value }}
							</td>
							<td class="cases-table__cell govuk-table__cell--numeric">
								<a id="expand-flags-{{ case.id }}" class="lite-accordian-table__chevron" onclick="return openTableFold(this);">
									{% if case.flags|length > 3 or case.users|length > 3 or case.queue_names|length > 3 %}
										{% svg 'chevron' %}
									{% endif %}
								</a>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
			{% if data.total_pages > 1 %}
				<br>
				<div class="lite-pagination__container ">
					{% for i in data.total_pages|times %}
						<a href="{% url 'cases:cases' %}?{{ params_str }}&page={{ i }}" class="lite-pagination__item {% if page == i %}lite-pagination__item--selected{% endif %}" id="page-{{ i }}">
							{{ i }}
						</a>
					{% endfor %}
				</div>
			{% endif %}
		{% else %}
			{% if params.case_type or params.status or params.case_officer or params.assigned_user %}
				{% include "includes/notice.html" with text="cases.CasesListPage.ACTIVE_FILTER_NO_CASES" %}
			{% else %}
				{% include "includes/notice.html" with text="cases.CasesListPage.NO_CASES" %}
			{% endif %}
		{% endif %}
	</form>
{% endblock %}

{% block javascript %}
	<script src="{% static 'javascripts/cases.js' %}"></script>
	<script src="{% static 'javascripts/select-buttons.js' %}"></script>
	<script nonce="{{ request.csp_nonce }}">
		function toggleDropdown() {
			$(".app-dropdown-background").toggle();
			$("#queues").toggleClass('app-dropdown__container--visible');
			$("#queue-title").toggleClass("app-dropdown__heading--flipped");
		}

		function setAssignUsersAbility() {
			// Disable the assign users button unless a checkbox is selected
			if ($("input[name='cases']:checked").length == 0) {
				disableButton("#assign-users-button");
			} else {
				enableButton("#assign-users-button");
			}
		}

		setAssignUsersAbility();

		$("#button-select-all").click(function() {
			setAssignUsersAbility();
		});

		$("input[name='cases']").change(function() {
			setAssignUsersAbility();
			$("#select-all-checkbox").prop('checked', $("input[name='cases']:checked").length == $("input[name='cases']").length);
			$("#select-all-checkbox").prop("indeterminate", $("input[name='cases']:checked").length > 0 && $("input[name='cases']:checked").length < $("input[name='cases']").length);
		});
	</script>
{% endblock %}
