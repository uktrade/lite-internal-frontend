{% extends 'layouts/base.html' %}

{% load humanize svg %}

{% block back_link %}{% endblock %}

{% block body %}

<form method="get" class="lite-dropdown-select">
	<select class="govuk-select" name="queue">
		{% for queue in queues.queues %}
			<option value="{{ queue.id }}" {% if queue.id == queue_id %}selected{% endif %}>{{ queue.name }}{{ queue.cases_count }}</option>
		{% endfor %}
	</select>
	<button type="submit" class="govuk-button">{% get_string 'cases.go_to_queue' %}</button>
</form>


<div class="lite-app-bar">
    <div>
        <a id="queue-title" href="#" class="govuk-heading-l lite-heading-dropdown" onclick="toggleDropdown()">{{ title }}</a>
    </div>
    <div class="lite-app-bar--right">
        <button id="assign-users-button" form="cases-form" type="submit" class="govuk-button govuk-button--secondary">Assign users</button>
    </div>
</div>
<div class="lite-dropdown-background" onclick="toggleDropdown()"></div>
<div class="lite-dropdown--container" id="queues">
    <div class="lite-dropdown">
        {% for queue in queues.queues %}
            <a href="/cases/?queue={{ queue.id }}" class="lite-dropdown--item {% if queue.id == queue_id %}lite-dropdown--item--selected{% endif %}">{{ queue.name }}
                <p float="right">({{ queue.cases_count }})</p>
            </a>
        {% endfor %}
    </div>
</div>

<div class="lite-js-only">
    <a href="#" onclick="toggleFilters()" id="show-filters-link" class="govuk-link govuk-link--no-visited-state lite-show-filters-link">
		{% svg 'filter_show' %}
		Show filters
	</a>
    <a href="#" onclick="toggleFilters()" id="hide-filters-link" class="govuk-link govuk-link--no-visited-state lite-hide-filters-link">
		{% svg 'filter_hide' %}
		Hide filters
	</a>
</div>

{{ cases|pretty_json }}

<form id="filters" action="{% url 'cases:cases'%}" method="get">
    <input hidden name="queue" value="{{ queue_id }}">

    <div class="govuk-grid-row lite-filter-bar--horizontal">
        <div class="govuk-grid-column-one-quarter">
            <label class="govuk-label" for="case_type">
                Filter by case type
            </label>
            <div class="lite-select-wrapper">
                <select class="govuk-select" id="case_type" name="case_type">
                    <option {% if case_type == None %}selected{% endif %} value="">Select</option>
                    <option {% if case_type ==  "application" %}selected{% endif %} value="application">Licence application</option>
                    <option {% if case_type == "clc_query" %}selected{% endif %} value="clc_query">CLC query</option>
                </select>
            </div>
        </div>
        <div class="govuk-grid-column-one-quarter">
            <label class="govuk-label" for="status">
                Filter by case status
            </label>
            <div class="lite-select-wrapper">
                <select class="govuk-select" id="status" name="status">
                    <option {% if status == None %}selected{% endif %} value="">Select</option>
                    {% for case_status in statuses.statuses %}
				        <option value="{{ case_status.status }}" {% if case_status.status == status %}selected{% endif %}>{{ case_status.status|default:"Untitled"|sentence_case }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="govuk-grid-column-one-half">
            <label class="govuk-label" for="filter" style="visibility: collapse;">
                --
            </label>
            <div class="lite-buttons-row">
                <button type="submit" form="filters" class="govuk-button" style="margin: 0;" id="button-apply-filters">
                    Apply filters
                </button>
                <a href="{% url 'cases:cases' %}?queue={{ queue_id }}" class="govuk-button govuk-button--secondary" style="margin-bottom: 0;" id="button-clear-filters">
                    Clear filters
                </a>
            </div>
        </div>
    </div>

</form>

<form id="cases-form" method="post">

	{% csrf_token %}

  	{% if cases.results|length %}
		<div class="lite-cases-table">
			<div class="lite-cases-table-header" {% if is_system_queue %}style="grid-template-columns: 30px 1fr 200px 200px 200px 200px"{% endif %}>
				<div class="govuk-checkboxes govuk-checkboxes--small">
					<div class="govuk-checkboxes__item">
						<input id="select-all-checkbox" class="govuk-checkboxes__input" type="checkbox">
						<label class="govuk-label govuk-checkboxes__label"></label>
					</div>
				</div>
				<div>
					<a href="#" class="lite-cases-table__heading">
						Case
					</a>
				</div>
				<div>
					<a href="#" class="lite-cases-table__heading">
						Assignees
					</a>
				</div>
				<div>
					<a href="#" class="lite-cases-table__heading">
						Type
					</a>
				</div>
                {% if is_system_queue %}
                    <h4>
                        Queues
                    </h4>
                {% endif %}
				<div>
					<a href="{{ current_filter_url }}sort={{ 'status'|table_sort_text:sort }}" class="lite-cases-table__heading {{ 'status'|table_sort:sort }}">
						Status
						{% svg 'chevron' %}
					</a>
				</div>
			</div>
			{% for case in cases.results %}
                {{ case }}
				<div class="lite-cases-table-row" {% if is_system_queue %}style="grid-template-columns: 30px 1fr 200px 200px 200px 200px"{% endif %}>
					<div class="govuk-checkboxes govuk-checkboxes--small">
						<div class="govuk-checkboxes__item">
							<input class="govuk-checkboxes__input" type="checkbox" name="cases" value="{{ case.id }}">
							<label class="govuk-label govuk-checkboxes__label"></label>
						</div>
					</div>
				</div>
			{% endfor %}

		<br><br>
		<div class="lite-pagination">
			{% for i in cases.total_pages|times %}
				<a href="{% url 'cases:cases' %}?page={{ i }}" class="lite-pagination__item {% if page == i %}lite-pagination__item--selected{% endif %}">
					{{ i }}
				</a>
			{% endfor %}
		</div>

    </div>

	{% else %}
		{% get_string 'cases.no_cases' as no_cases_text %}
		{% include "includes/information-text.html" with text=no_cases_text %}
	{% endif %}

</form>

<script>
	$("#filters").hide();
	$("#show-filters-link").show();
	$("#hide-filters-link").hide();

	{% if case_type or status %}
		$("#filters").show();
		$("#show-filters-link").hide();
		$("#hide-filters-link").show();
	{% endif %}

	function toggleFilters() {
		$("#filters").toggle();
		if ($("#filters").is(':visible')) {
			$("#show-filters-link").hide();
			$("#hide-filters-link").show();
		} else {
			$("#show-filters-link").show();
			$("#hide-filters-link").hide();
		}
	}

	function toggleDropdown() {
		$(".lite-dropdown-background").toggle();
		$("#queues").toggleClass('lite-dropdown--visible');
		$("#queue-title").toggleClass("lite-heading-dropdown--flipped");
	}

	function setAssignUsersAbility() {
		// Disable the assign users button unless a checkbox is selected
		if ($("input[name='cases']:checked").length == 0) {
			$("#assign-users-button").prop('disabled', true).addClass("govuk-button--disabled");
		} else {
			$("#assign-users-button").prop('disabled', false).removeClass("govuk-button--disabled");
		}
	}

	setAssignUsersAbility();

	$("#select-all-checkbox").click(function() {
		if ($("input[name='cases']:checked").length == $("input[name='cases']").length) {
			$("input[name='cases']").prop('checked', false);
	   } else {
		   $("input[name='cases']").prop('checked', true);
	   }

		setAssignUsersAbility();
	});

	$("input[name='cases']").change(function() {
		setAssignUsersAbility();
		$("#select-all-checkbox").prop('checked', $("input[name='cases']:checked").length == $("input[name='cases']").length);
		$("#select-all-checkbox").prop("indeterminate", $("input[name='cases']:checked").length > 0 && $("input[name='cases']:checked").length < $("input[name='cases']").length);
	});
</script>
{% endblock %}
