{% load static %}

<h3 class="govuk-heading-m">Activity</h3>

<form method="post" onSubmit="return confirmVisible()">
	{% csrf_token %}
	<div class="lite-expandable-textarea lite-case-note-no-transition">
		<textarea id="case_note" name="text" cols="80" class="govuk-textarea" placeholder="Add case note"></textarea>
		<div class="lite-expandable-textarea-controls">
            <div class="govuk-checkboxes govuk-checkboxes--small">
						<div class="govuk-checkboxes__item">
							<input class="govuk-checkboxes__input" type="checkbox" id="is_visible_to_exporter" name="is_visible_to_exporter" value="True">
							<label class="govuk-label govuk-checkboxes__label" for="is_visible_to_exporter">Make visible to exporter</label>
						</div>
					</div>
			<a id="case-note-cancel-button" href="{% url 'cases:case' case.id %}" class="govuk-button govuk-button--secondary govuk-button--secondary-white" type="button" draggable="false">
				Cancel
			</a>
			<button class="govuk-button" type="submit" id="button-post-note">
				Post note
			</button>
		</div>
	</div>
	<p id="case_note-warning" class="govuk-hint govuk-character-count__message" aria-live="polite">
		{% get_string 'cases.case.tabs.activity.2200_character_limit' %}
	</p>
</form>

<div class="lite-case-notes">
	{% for item in activity %}
		{% if item.type == 'case_note' %}
			<div class="lite-activity-item">
				<p class="govuk-body" style="margin-bottom: 0;">
					<span class="user">{{ item.user.first_name }} {{ item.user.last_name }}</span>{% get_string 'activity.added_a_case_note' %}
				</p>

				<div class="lite-case-note {% if item.user.organisation %}lite-case-note--exporter{% endif %}">
					{{ item.data }}
				</div>
				<p class="govuk-hint govuk-!-font-size-16" style="margin-top: 10px;">{{ item.date|str_date }}</p>
			</div>
		{% elif item.type == 'change' %}
			<div class="lite-activity-item">
				<p class="govuk-body" style="margin-bottom: 0;">
					{% for key, value in item.data.items %}
						{% if forloop.first %}
							<span class="user">{{ item.user.first_name }} {{ item.user.last_name }}</span> set the
						{% endif %}
						<span class="highlight">{{ key }}</span> to <span class="highlight">{{ value|sentence_case|lower }}</span>{% if not forloop.last %}{% ifequal forloop.revcounter 2 %} and {% else %}, {% endifequal %}{% else %}.{% endif %}
					{% endfor %}
				</p>
				<p class="govuk-hint govuk-!-font-size-16" style="margin-top: 10px;">{{ item.date|str_date }}</p>
			</div>
		{% elif item.type == 'change_case_flags' %}
			<div class="lite-activity-item">
				<p class="govuk-body" style="margin-bottom: 0;">
					<span class="user">{{ item.user.first_name }} {{ item.user.last_name }}</span>
					{% if item.data.flags.removed|length > 0 %}
						removed flags:
						{% for flag in item.data.flags.removed %}
							<span class="highlight">{{ flag|sentence_case|lower }}</span>{% if not forloop.last %}, {% else %}{% if item.flags.added|length > 0 %} and {% else %}{% if item.data.flags.removed|length > 0 and item.data.flags.added|length > 0 %},{% else %}.{% endif %}{% endif %}{% endif %}
						{% endfor %}
					{% endif %}
					{% if item.data.flags.removed|length > 0 and item.data.flags.added|length > 0 %}
						and
					{% endif %}
					{% if item.data.flags.added|length > 0 %}
						added flags:
						{% for flag in item.data.flags.added %}
							<span class="highlight">{{ flag|sentence_case|lower }}</span>{% if not forloop.last %}, {% else %}.{% endif %}
						{% endfor %}
					{% endif %}
                    <br>
                    {% if item.data.flags.note|length %}
                        Note:
                        {{ item.data.flags.note }}
                    {% endif %}
				</p>
				<p class="govuk-hint govuk-!-font-size-16" style="margin-top: 10px;">{{ item.date|str_date }}</p>
			</div>
        {% elif item.type == 'change_good_flags' %}
			<div class="lite-activity-item">
				<p class="govuk-body" style="margin-bottom: 0;">
					<span class="user">{{ item.user.first_name }} {{ item.user.last_name }}</span>
                    for good: <span class="highlight">{{ item.data.good }}</span>,
					{% if item.data.flags.removed|length > 0 %}
						removed flags:
						{% for flag in item.data.flags.removed %}
							<span class="highlight">{{ flag|sentence_case|lower }}</span>{% if not forloop.last %}, {% else %}{% if item.flags.added|length > 0 %} and {% else %}{% if item.data.flags.removed|length > 0 and item.data.flags.added|length > 0 %},{% else %}.{% endif %}{% endif %}{% endif %}
						{% endfor %}
					{% endif %}
					{% if item.data.flags.removed|length > 0 and item.data.flags.added|length > 0 %}
						and
					{% endif %}
					{% if item.data.flags.added|length > 0 %}
						added flags:
						{% for flag in item.data.flags.added %}
							<span class="highlight">{{ flag|sentence_case|lower }}</span>{% if not forloop.last %}, {% else %}.{% endif %}
						{% endfor %}
					{% endif %}
                    <br>
                    {% if item.data.flags.note|length %}
                        Note:
                        {{ item.data.flags.note }}
                    {% endif %}
				</p>
				<p class="govuk-hint govuk-!-font-size-16" style="margin-top: 10px;">{{ item.date|str_date }}</p>
			</div>
        {% elif item.type == 'ecju_query' %}
			<div class="lite-activity-item">
				<p class="govuk-body" style="margin-bottom: 0;">
					<span class="user">{{ item.user.first_name }} {{ item.user.last_name }}</span>{% get_string 'activity.added_an_ecju_query' %}
                    <span class="highlight">{{ item.data|slice:"0:40" }}{% if item.data|length > 40 %}...{% endif %}</span>
				</p>
				<p class="govuk-hint govuk-!-font-size-16" style="margin-top: 10px;">{{ item.date|str_date }}</p>
			</div>
		{% endif %}
	{% endfor %}
</div>
<script src="{% static 'javascripts/pluralize.js' %}"></script>
<script src="{% static 'javascripts/case_notes.js' %}"></script>
<script>
    function confirmVisible() {
        let is_visible_for_exporter = document.getElementById('is_visible_to_exporter')
        if (is_visible_for_exporter.checked) {
            return confirm("This message will be visible to the exporter, are you sure you wish to continue?")
        }
        return true;
    }
</script>
