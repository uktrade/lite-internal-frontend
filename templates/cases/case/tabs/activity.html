{% load humanize static %}

<h3 class="govuk-heading-m">Activity</h3>

<form method="post" onSubmit="return confirmVisible(event)">
	{% csrf_token %}
	<div class="lite-expandable-textarea lite-case-note-no-transition">
		<textarea id="case_note" name="text" cols="80" class="govuk-textarea" placeholder="Add case note"></textarea>
		<div class="lite-expandable-textarea-controls">
			<div class="govuk-checkboxes govuk-checkboxes--small">
				<div class="govuk-checkboxes__item">
					<input class="govuk-checkboxes__input" type="checkbox" id="is_visible_to_exporter" name="is_visible_to_exporter" value="True">
					<label class="govuk-label govuk-checkboxes__label" for="is_visible_to_exporter">{% get_string 'cases.case.tabs.activity.make_visible_to_exporter' %}</label>
				</div>
			</div>
			<a id="case-note-cancel-button" href="{% url 'cases:case' data.case.id %}" class="govuk-button govuk-button--secondary" type="button" draggable="false">
				Cancel
			</a>
			<button class="govuk-button" type="submit" id="button-post-note">
				Post note
			</button>
		</div>
	</div>
	<p id="case_note-warning" class="govuk-hint govuk-character-count__message" aria-live="polite">
		{% get_string 'cases.case.tabs.activity.2200_character_limit' %}
	</p>
</form>

<div class="lite-case-notes">
	{% for item in activity %}
		<div class="lite-activity-item">
			{% if item.type == 'case_note' %}
				<p class="govuk-body" style="margin-bottom: 0;">
					<span class="user">{{ item.user.first_name }} {{ item.user.last_name }}</span> ({{ item.user.team.name }}{{ item.user.organisation.name }}) {% get_string 'activity.added_a_case_note' %}
				</p>
				<div class="lite-case-note {% if item.user.organisation %}lite-case-note--exporter{% endif %}">
					{{ item.data }}
				</div>
			{% elif item.type == 'change' %}
				<p class="govuk-body" style="margin-bottom: 0;">
					{% for key, value in item.data.items %}
						{% if forloop.first %}<span class="user">{{ item.user.first_name }} {{ item.user.last_name }}</span> ({{ item.user.team.name }}{{ item.user.organisation.name }}) set{% endif %} the <span class="highlight">{{ key }}</span> to <span class="highlight">{{ value|sentence_case|lower }}</span>{% if not forloop.last %}{% ifequal forloop.revcounter 2 %} and {% else %}, {% endifequal %}{% else %}.{% endif %}
					{% endfor %}
				</p>
			{% endif %}
			<p class="govuk-hint govuk-!-font-size-16" style="margin-top: 10px;">{{ item.date|str_date }} {% if item.status %}- {{ item.status }}{% endif %}</p>
		</div>
	{% endfor %}
</div>

<script>
    function confirmVisible(event) {
        let is_visible_to_exporter = document.getElementById('is_visible_to_exporter')
        if (is_visible_to_exporter.checked) {
            return confirm("This message will be visible to the exporter, are you sure you wish to continue?")
        }
        return true;
    }
</script>

<script src="{% static 'javascripts/pluralize.js' %}"></script>
<script src="{% static 'javascripts/specific/case_notes.js' %}"></script>
<script>
    function confirmVisible(event) {
        let is_visible_for_exporter = document.getElementById('is_visible_for_exporter')
        if (is_visible_for_exporter.checked) {
            return confirm("This message will be visible to the exporter, are you sure you wish to continue?")
        }
        return true;
    }
</script>
