{% extends 'layouts/base.html' %}

{% load humanize static %}

{% block back_link %}
	<div class="govuk-breadcrumbs">
		<ol class="govuk-breadcrumbs__list">
			<li class="govuk-breadcrumbs__list-item">
				<a class="govuk-breadcrumbs__link" href="{% url 'cases:cases' %}?queue={{ queue.queue.id }}">{% if queue_name %}{{ queue_name }}{% else %}{% lcs 'QUEUE_ALL_CASES' %}{% endif %}</a>
			</li>
			<li class="govuk-breadcrumbs__list-item" aria-current="page">&nbsp;</li>
		</ol>
	</div>
{% endblock %}

{% block body %}
    {% if case.audit_notification %}
        <a id="audit-notification" class="lite-info-bar lite-info-bar--link lite-info-bar--no-animation" href="#case-activity-{{ case.audit_notification.audit_id }}">
            {% lcs 'CASE_CHANGES' %}
        </a>
    {% endif %}

<div class="lite-app-bar">
	<div class="lite-app-bar__content">
		<p class="govuk-caption-m" style="margin: 0;">{{ case.application.application_type.value }}</p>
		<h2 class="govuk-heading-l">{{ title }}</h2>
        <p class="govuk-caption-m">{% lcs 'CASES.HMRCPage.Heading.EXPORTER' %}<a id="applicant_organisation" class="govuk-link govuk-link--no-visited-state" style="display: inline-block;" href="{% url 'organisations:organisation' case.application.organisation.id %}">{{ case.application.organisation.name }}</a></p>
        <p class="govuk-caption-m">{% lcs 'CASES.HMRCPage.Heading.RAISED_BY' %}<a id="hmrc_organisation" class="govuk-link govuk-link--no-visited-state" style="display: inline-block;" href="{% url 'organisations:organisation' case.application.hmrc_organisation.id %}">{{ case.application.hmrc_organisation.name }}</a></p>
	</div>
	<div class="lite-app-bar__controls">
		<div class="app-more-actions__container">
			<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:documents' case.id %}">
	           	{% lcs 'CASES.HMRCPage.Actions.DOCUMENT' %}
	        </a>
	        <a role="button" draggable="false" class="govuk-button" href="{% url 'cases:move' case.id %}">
				{% lcs 'CASES.HMRCPage.Actions.MOVE' %}
			</a>
            {% if not status_is_terminal or 'REOPEN_CLOSED_CASES' in permissions %}
			<a role="button" draggable="false" class="govuk-button" id="change-status" href="{% url 'cases:manage' case.id %}">
				{% lcs 'CASES.HMRCPage.Actions.CHANGE_STATUS' %}
			</a>
            {% endif %}
			{% if permissions|key_in_array:'MAKE_FINAL_DECISIONS' and not status_is_terminal%}
				<a role="button" draggable="false" class="govuk-button" href="{% url 'cases:decide' case.id %}">
					{% lcs 'CASES.HMRCPage.Actions.RECORD_DECISION' %}
				</a>
			{% endif %}
            <a role="button" draggable="false" class="govuk-button" id="generate-document" href="{% url 'cases:generate_document' case.id %}">
                {% lcs 'CASES.ApplicationPage.Actions.GENERATE_DOCUMENT' %}
            </a>
            <a role="button" draggable="false" class="govuk-button" id="case-officer" href="{% url 'cases:case_officer' case.id %}">
                {% lcs 'CASES.ApplicationPage.Actions.CASE_OFFICER' %}
            </a>
		</div>
	</div>
</div>

{% if case.case_officer %}
    <p class="govuk-caption-m">{% lcs 'CASES.ApplicationPage.CASE_OFFICER' %} <a class="govuk-link govuk-link--no-visited-state" href="{% url 'users:user' case.case_officer.id %}">{{ case.case_officer|username }}</a></p>
{% else %}
    <p class="govuk-caption-m">{% lcs 'CASES.ApplicationPage.NO_CASE_OFFICER' %}</p>
{% endif %}

{% if case.all_flags %}
    <p class="govuk-caption-m">{% lcs 'CASES.HMRCPage.CASE_FLAGS' %}</p>
    <div class="app-flags">
        {% for flag in case.all_flags %}
            <div class="app-flag" id="{{ flag.name }}">
                {{ flag.name }}
            </div>
        {% endfor %}
    </div>
    <br>
{% endif %}

<!-- Case flags -->
{% include 'case/views/case-flags.html' %}

<!-- Information board -->
{% include 'case/views/application-information-board.html' %}

{% if case.application.application_denial_reason %}
    <h3 class="govuk-heading-m">{% lcs 'CASES.HMRCPage.DenialReasons.TITLE' %}</h3>
    {% for reason in case.application.application_denial_reason %}
        <p class="govuk-heading-s">{% lcs 'CASES.HMRCPage.DenialReasons.REASON' %}</p>
        {% for reason_id in reason.reasons %}
            <p class="govuk-label">{{ reason_id.id }}</p>
        {% endfor %}
        {% if reason.reason_details %}
            <br />
            <p class="govuk-heading-s">{% lcs 'CASES.HMRCPage.DenialReasons.FURTHER_INFO' %}</p>
            <p class="govuk-label">{{ reason.reason_details }}</p>
        {% endif %}
    {% endfor %}
    <br /><br />
{% endif %}

<!-- Goods -->

<form action="{% url 'cases:review_goods' case.id %}" method="get">
	{% if 'REVIEW_GOODS' in permissions and not status_is_terminal %}
		<button id="button-review-goods" name="action" value="review-goods" class="govuk-button" data-module="govuk-button">
			{% lcs 'CASES.HMRCPage.Good.REVIEW_GOODS' %}
		</button>
	{% endif %}
    <button id="button-edit-goods-flags" name="action" value="edit-flags" class="govuk-button" data-module="govuk-button">
		{% lcs 'CASES.HMRCPage.Good.EDIT_FLAGS' %}
	</button>
    <table class="govuk-table">
        <thead class="govuk-table__header">
            <tr>
                <th class="govuk-table__header" scope="col">{% lcs 'CASES.HMRCPage.Good.DESCRIPTION' %}</th>
                <th class="govuk-table__header" scope="col">{% lcs 'CASES.HMRCPage.Good.CONTROL_CODE' %}</th>
                <th class="govuk-table__header" scope="col">{% lcs 'CASES.HMRCPage.Good.CONTROLLED' %}</th>
                <th class="govuk-table__header" scope="col">{% lcs 'CASES.HMRCPage.Good.FLAGS' %}</th>
            </tr>
        </thead>
        <tbody>
            {% for good in case.application.goods_types %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">
                        <div class="govuk-checkboxes--small govuk-checkboxes__item">
                            <input class="govuk-checkboxes__input" type="checkbox" name="goods" value="{{ good.id }}" id="{{ good.id }}">
                            <label class="govuk-label govuk-checkboxes__label" for="{{ good.id }}">{{ good.description }}</label>
                        </div>
                    </td>
                    <td class="govuk-table__cell">
                        <span class="app-country-tag app-country-tag--orange">{{ good.control_code|default_na }}</span>
                    </td>
                    <td class="govuk-table__cell">
                        {{ good.is_good_controlled|friendly_boolean }}
                    </td>
                    <td class="govuk-table__cell">
                        {% if good.flags %}
                            {% for flag in good.flags %}
                                {{ flag.name }}<br>
                            {% endfor %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</form>

<!-- Destinations/End-User -->
{% include 'case/views/standard-destinations.html' %}

<!--TODO: Fix this JF-->
{% if case.application.supporting_documentation %}
<h3 class="govuk-heading-m">{% lcs 'CASES.HMRCPage.SupportingDocumentation.TITLE' %}</h3>
	<table class="govuk-table" id="supporting-documentation">
		<thead class="govuk-table__head">
			<tr class="govuk-table__row">
				<th class="govuk-table__header" scope="col">{% lcs 'CASES.HMRCPage.SupportingDocumentation.NAME' %}</th>
				<th class="govuk-table__header" scope="col">{% lcs 'CASES.HMRCPage.SupportingDocumentation.DESCRIPTION' %}</th>
                <th class="govuk-table__header" scope="col">{% lcs 'CASES.HMRCPage.SupportingDocumentation.DOCUMENT' %}</th>
			</tr>
		</thead>
		<tbody class="govuk-table__body">
        {%  for supporting_documentation in case.application.supporting_documentation %}
            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    {{ supporting_documentation.name }}
                </td>
                <td class="govuk-table__cell">
                    {{ supporting_documentation.description }}
                </td>
                <td class="govuk-table__cell">
                    {% if supporting_documentation.safe == True %}
                    <a class="govuk-link govuk-link--no-visited-state" id="supporting_documentation-{{ supporting_documentation.id }}" href="{% url 'cases:document' case.id supporting_documentation.id %}">
                        <span class="govuk-visually-hidden">{% lcs 'Cases.Manage.Documents.DOWNLOAD_DOCUMENT' %}</span>
                        {{ supporting_documentation.name }}<br>
                    </a>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
		</tbody>
	</table>
{% endif %}

    {% include "case/views/activity.html" %}
{% endblock %}

{% block javascript %}
	<script src="{% static 'javascripts/more-actions.js' %}"></script>
	<script src="{% static 'javascripts/edit-good-flags.js' %}"></script>
{% endblock %}
